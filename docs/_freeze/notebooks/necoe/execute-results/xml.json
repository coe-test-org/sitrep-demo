{
  "hash": "f3f4823c55978cba00ac8f5b4a7b5f7d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: New England Genomics Center of Excellence\ndate: today\n---\n\n\n\n\n\n\n\n\n\n\n# Set up\n\nThis is just an example. We're going to pull in covid data made from the new york times\n\n**FOR THIS TO WORK:** \n  \n1.    run `renv::install('devtools')` if it's not already installed\n2.    then `devtools::install_github(\"covid19R/covid19nytimes\")` if it's not already installed\n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nknitr::opts_chunk$set(echo = TRUE, eval = TRUE)\n\n# correlate deaths and cases by state\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'tidyverse' was built under R version 4.2.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'tidyr' was built under R version 4.2.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(covid19nytimes)\nlibrary(lubridate)\nlibrary(broom)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'broom' was built under R version 4.2.3\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(knitr)\n\n# source https://github.com/nytimes/covid-19-data.git\nus_states_long <- covid19nytimes::refresh_covid19nytimes_states()\n\n# The following filter is to restrict the data to that originally posted at\n# https://outsiderdata.netlify.app/post/covid-cases-vs-deaths/\n# Should you wish to update the models with the latest data, remove the\n# following statement.\nus_states_long <- us_states_long %>% filter(date < ymd(\"2020-12-06\"))\n\n# if link is broken\n# load(\"../data/us_states_long.rdata\")\n\n# use data from November 15 to stay consistent with text narrative\ncutoff_start <- as.Date(\"2020-03-15\") # not widespread enough until then\ncutoff_end <- max(us_states_long$date) - 7 # discard last week since there are reporting lags\n\nus_states_long <- us_states_long %>% filter(date >= cutoff_start)\nus_states_long <- us_states_long %>% filter(date <= cutoff_end)\n# Remove tiny territories\nterritories <- c(\"Guam\", \"Northern Mariana Islands\")\nus_states_long <- us_states_long %>% filter(!(location %in% territories))\nsave(us_states_long, file = \"us_states_long.rdata\")\n```\n:::\n\n\n\n\n\n\n\n\n\n\n# Create rolling average changes\n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create rolling average changes\n# pivot wider\n# this will also be needed when we create lags\nus_states <- us_states_long %>%\n  # discard dates before cases were tracked.\n  filter(date > as.Date(\"2020-03-01\")) %>%\n  pivot_wider(names_from = \"data_type\", values_from = \"value\") %>%\n  rename(state = location) %>%\n  select(date, state, cases_total, deaths_total) %>%\n  mutate(state = as_factor(state)) %>%\n  arrange(state, date) %>%\n  group_by(state) %>%\n  # smooth the data with 7 day moving average\n  mutate(cases_7day = (cases_total - lag(cases_total, 7)) / 7) %>%\n  mutate(deaths_7day = (deaths_total - lag(deaths_total, 7)) / 7)\n```\n:::\n\n::: {#cell-fig-state-analysis .cell}\n\n```{.r .cell-code}\n#| warning: false\n#| message: false\n#| label: fig-state-analysis\n#| fig-cap: \"From the New York Times: A couple of observations are obvious. First when cases start to rise, deaths follow with a lag. Second, we have had three spikes in cases so far and in each successive instance the mortality has risen by a smaller amount. This suggests that, thankfully, we are getting better at treating this disease. It is NOT a function of increased testing because positivity rates have not been falling.\"\n\n# ------------------------------------------\n# state by state analysis\n\ncoeff <- 30\nstate_subset <- c(\"Washington\", \"Massachusetts\", \"Georgia\", \"Minnesota\", \"Virginia\")\n\n# illustrate selected states\ng <- us_states %>%\n  filter(state %in% state_subset) %>%\n  ggplot(aes(date, cases_7day)) +\n  geom_line(color = \"orange\") +\n  facet_wrap(~state, scales = \"free\") +\n  theme(legend.position = \"none\") +\n  geom_line(aes(y = deaths_7day * coeff), color = \"red\") +\n  scale_y_continuous(\n    labels = scales::comma,\n    name = \"Cases\",\n    sec.axis = sec_axis(deaths_7day ~ . / coeff,\n      name = \"Deaths\",\n      labels = scales::comma\n    )\n  ) +\n  theme(\n    axis.title.y = element_text(color = \"orange\", size = 13),\n    axis.title.y.right = element_text(color = \"red\", size = 13)\n  ) +\n  labs(\n    title = \"U.S. Cases vs. Deaths\",\n    subtitle = \"7-Day Average\",\n    caption = \"Source: NY Times, Arthur Steinmetz\",\n    x = \"Date\"\n  )\nshow(g)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Removed 7 rows containing missing values or values outside the scale range\n(`geom_line()`).\nRemoved 7 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![From the New York Times: A couple of observations are obvious. First when cases start to rise, deaths follow with a lag. Second, we have had three spikes in cases so far and in each successive instance the mortality has risen by a smaller amount. This suggests that, thankfully, we are getting better at treating this disease. It is NOT a function of increased testing because positivity rates have not been falling.](necoe_files/figure-jats/fig-state-analysis-1.png){#fig-state-analysis}\n:::\n:::\n",
    "supporting": [
      "necoe_files\\figure-jats"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}