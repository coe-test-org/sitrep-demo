{
  "hash": "3b9c9e5c2f2dabc9cdc780ab4aedd8f0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Virginia Genomics Center of Excellence\ndate: today\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# correlate deaths and cases by state\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'tidyverse' was built under R version 4.2.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'tidyr' was built under R version 4.2.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(covid19nytimes)\nlibrary(lubridate)\nlibrary(broom)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'broom' was built under R version 4.2.3\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(knitr)\nlibrary(timetk)\n\n# source https://github.com/nytimes/covid-19-data.git\nus_states_long <- covid19nytimes::refresh_covid19nytimes_states()\n\n# The following filter is to restrict the data to that originally posted at\n# https://outsiderdata.netlify.app/post/covid-cases-vs-deaths/\n# Should you wish to update the models with the latest data, remove the\n# following statement.\nus_states_long <- us_states_long %>% filter(date < ymd(\"2020-12-06\"))\n\n# if link is broken\n# load(\"../data/us_states_long.rdata\")\n\n# use data from November 15 to stay consistent with text narrative\ncutoff_start <- as.Date(\"2020-03-15\") # not widespread enough until then\ncutoff_end <- max(us_states_long$date) - 7 # discard last week since there are reporting lags\n\nus_states_long <- us_states_long %>% filter(date >= cutoff_start)\nus_states_long <- us_states_long %>% filter(date <= cutoff_end)\n# Remove tiny territories\nterritories <- c(\"Guam\", \"Northern Mariana Islands\")\nus_states_long <- us_states_long %>% filter(!(location %in% territories))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Create rolling average changes\n# pivot wider\n# this will also be needed when we create lags\nus_states <- us_states_long %>%\n  # discard dates before cases were tracked.\n  filter(date > as.Date(\"2020-03-01\")) %>%\n  pivot_wider(names_from = \"data_type\", values_from = \"value\") %>%\n  rename(state = location) %>%\n  select(date, state, cases_total, deaths_total) %>%\n  mutate(state = as_factor(state)) %>%\n  arrange(state, date) %>%\n  group_by(state) %>%\n  # smooth the data with 7 day moving average\n  mutate(cases_7day = (cases_total - lag(cases_total, 7)) / 7) %>%\n  mutate(deaths_7day = (deaths_total - lag(deaths_total, 7)) / 7)\n\n# national analysis\n# ----------------------------------------------\n# aggregate state to national\nus <- us_states %>%\n  group_by(date) %>%\n  summarize(across(\n    .cols = where(is.double),\n    .fns = function(x) sum(x, na.rm = T),\n    .names = \"{col}\"\n  ))\n\n# create columns for deaths led 0 to 40 days ahead\nmax_lead <- 40\nus_lags <- us %>%\n  # create lags by day\n  tk_augment_lags(deaths_7day, .lags = 0:-max_lead, .names = \"auto\")\n# fix names to remove minus sign\nnames(us_lags) <- names(us_lags) %>% str_replace_all(\"lag-|lag\", \"lead\")\n\n# use only case dates where we have complete future knowledge of deaths for all lead times.\nus_lags <- us_lags %>% filter(date < cutoff_end - max_lead)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# make long form to nest\n# initialize models data frame\nmodels <- us_lags %>%\n  ungroup() %>%\n  pivot_longer(\n    cols = contains(\"lead\"),\n    names_to = \"lead\",\n    values_to = \"led_deaths\"\n  ) %>%\n  select(date, cases_7day, lead, led_deaths) %>%\n  mutate(lead = as.numeric(str_remove(lead, \"deaths_7day_lead\"))) %>%\n  nest(data = c(date, cases_7day, led_deaths)) %>%\n  # Run a regression on lagged cases and date vs deaths\n  mutate(model = map(\n    data,\n    function(df) {\n      lm(led_deaths ~ cases_7day + poly(as.numeric(as.Date(date)), 2), data = df)\n    }\n  ))\n\n# Add regression coefficient\n# get adjusted r squared\nmodels <- models %>%\n  mutate(adj_r = map(model, function(x) {\n    glance(x) %>%\n      pull(adj.r.squared)\n  })\n  %>% unlist())\nprint(models)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 41 × 4\n    lead data               model  adj_r\n   <dbl> <list>             <list> <dbl>\n 1     0 <tibble [218 × 3]> <lm>   0.164\n 2     1 <tibble [218 × 3]> <lm>   0.187\n 3     2 <tibble [218 × 3]> <lm>   0.212\n 4     3 <tibble [218 × 3]> <lm>   0.241\n 5     4 <tibble [218 × 3]> <lm>   0.272\n 6     5 <tibble [218 × 3]> <lm>   0.307\n 7     6 <tibble [218 × 3]> <lm>   0.343\n 8     7 <tibble [218 × 3]> <lm>   0.383\n 9     8 <tibble [218 × 3]> <lm>   0.424\n10     9 <tibble [218 × 3]> <lm>   0.467\n# ℹ 31 more rows\n```\n\n\n:::\n:::\n\n\n\n\n\n\n# Model Fit\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Show model fit by lead time\n# make predictions using best model\nbest_fit <- models %>%\n  summarize(adj_r = max(adj_r)) %>%\n  left_join(models, by = \"adj_r\")\n\ng <- models %>%\n  ggplot(aes(lead, adj_r)) +\n  geom_line() +\n  labs(\n    subtitle = paste(\"Best fit lead =\", best_fit$lead, \"days\"),\n    title = \"Model Fit By Lag Days\",\n    x = \"Lead Time in Days for Deaths\",\n    caption = \"Source: NY Times, Arthur Steinmetz\",\n    y = \"Adjusted R-squared\"\n  )\nshow(g)\n```\n\n::: {.cell-output-display}\n![](vacoe_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n# Main Plot\n\n\n\n\n\n\n::: {#cell-fig-fatality-plot .cell}\n\n```{.r .cell-code .hidden}\n#| warning: false\n#| message: false\n#| label: fig-fatality-plot\n#| fig-cap: \"COVID-19 fatalities, outputs from New York Times modeling.\"\n\nfatality <- best_fit$data[[1]] %>%\n  filter(cases_7day > 0) %>%\n  filter(date > as.Date(\"2020-04-15\")) %>%\n  mutate(rate = led_deaths / cases_7day)\n\ng <- fatality %>% ggplot(aes(date, rate)) +\n  geom_line() +\n  geom_smooth() +\n  labs(\n    x = \"Date\", y = \"Fatality Rate\",\n    title = \"Fatality Rates are Creeping Up\",\n    subtitle = \"Fatality Rate as a Percentage of Lagged Cases\",\n    caption = \"Source: NY Times, Arthur Steinmetz\"\n  ) +\n  scale_y_continuous(labels = scales::percent)\nshow(g)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![COVID-19 fatalities, outputs from New York Times modeling.](vacoe_files/figure-html/fig-fatality-plot-1.png){#fig-fatality-plot width=672}\n:::\n:::\n",
    "supporting": [
      "vacoe_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}